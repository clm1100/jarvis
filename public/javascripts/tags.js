function sort(){var a=$("#list_filter").val();$.trim(a).length>0?window.location.href="/tags/"+a+"/sortable":BootstrapDialog.alert("请选择一个列表分类")}function create(){window.location.href="/tags/new"}function edit(a){window.open("/tags/"+a,"_blank")}function reset(){$("#list_filter").val(""),datatables.draw()}function destroy(a){$.ajax({url:"/tags/"+a,type:"DELETE",success:function(a){$(".alert strong").html(a.message),$(".alert").show().fadeIn(),datatables?datatables.draw():history.go(-1)}})}function changeImgPosition(){var a=$("#sortable-list");if(a.length>0){var b=a.attr("data-commodityid");a.sortable("destroy"),a.sortable({sort:!0,scroll:!0,animation:100,ghostClass:"sortable-ghost",onEnd:function(a){var c=[];$.each($("#sortable-list").find(".list-group-item"),function(a,b){if(0===a){var d=$("#commodity-main-img");d.find("img").attr("src",$(b).attr("src"))}c.push({id:$(b).attr("data-id"),position:++a})});var d="/tags/"+b+"/photos/position";$.post(d,{list:c},function(a){})}})}}function deleteImg(a){var b=$("#sortable-list").attr("data-commodityid"),c="/tags/"+b+"/photo/"+a;$.post(c,function(a){$.each($("#sortable-list").find(".list-group-item"),function(a,b){if(0===a){var c=$("#commodity-main-img");c.find("img").attr("src",$(b).attr("src"))}}),changeImgPosition()})}function showAddAds(){$("#add-ad-modal").modal("show"),$("#ad-search-input").val(""),$("#ads-result-list").find("> ul").html("")}function saveAds(){var a=url(-1,window.location.href),b=$("#ads-result-list input[name=ads]:checked").map(function(){return $(this).val()}).get(),c=$("#ads-list-group input[name=ads]:checked").map(function(){return $(this).val()}).get();b=c.concat(b);var d=doT.template($("#ads-result").text()),e="/tags/"+a+"/ads";$.post(e,{ads:b},function(a){$("#ads-list-group").html(d(a)),$("#add-ad-modal").modal("hide")})}function searchAds(){var a=($("#ads-list-select option:selected").val(),$("#ad-search-input").val());if($.trim(a).length<1)return!1;var b=doT.template($("#ads-tpl").text()),c="/api/ads/search/"+a+"/0";return $.get(c,function(a){$("#ads-result-list").find("ul").append(b(a))}),!0}var datatables;$(document).ready(function(){var a=$("#main-datatables");a&&(datatables=a.DataTable({language:{url:"/javascripts/libs/datatables-chinese.json"},processing:!0,serverSide:!0,ajax:"/api/tags",fnServerParams:function(a){var b=[],c=$("#list_filter").val();c&&c.length>0&&b.push({i:1,value:c}),a.filters=b},columns:[{name:"_id"},{name:"list"},{name:"t"},{name:"synonyms"},{name:"associations"},{name:"cover"},{name:"limit"},{name:"used"},{name:"position"}],columnDefs:[{targets:[5],render:function(a,b,c){return a?'<a data-lightbox="'+c[0]+'" href="'+a.replace("!thumb","")+'"><img src="'+a+'" width="24"></a>':""}},{targets:[6],render:function(a,b,c){return-1===a?"无限制":a}},{targets:[9],render:function(a,b,c){return"<button onclick=\"edit('"+c[0]+"')\" class=\"btn btn-info\">编辑</button>&nbsp;<button onclick='destroy('"+c[0]+'\')" class="btn btn-danger">删除</button>'}}]}),$("#list_filter").change(function(){datatables.draw()}));var b=$("#cover-input");if(b.length>0){new ImagePreview("#cover-input",{placeholder:"#cover-preview",height:"128px",callback:function(){$("#show-cover-link").attr("href",$("#cover-preview").find("> img").attr("src"))}})}changeImgPosition();var c=$("#ads-list-group");c.length>0&&c.sortable({sort:!0,scroll:!0,animation:100,ghostClass:"sortable-ghost",onEnd:function(a){var b=[];$.each($(".list-group-item"),function(a,c){b.push({id:$(c).attr("data-id"),position:++a})});var c=$("#list_filter").val(),d="/tags/"+c+"/sortable";$.post(d,{items:b},function(a){})}}),$("#photo-input").change(function(){var a="/api/photos/upload/signature",b=document.getElementById("photo-input").files[0],c=Math.floor((new Date).getTime()/1e3)+86400;$.post(a,{filename:b.name,expiration:c},function(a){var c=new FormData;c.append("policy",a.policy),c.append("signature",a.signature),c.append("file",b),c.append("x-gmkerl-rotate","auto"),$.ajax({url:UPYUN_MORETAO,type:"POST",data:c,mimeType:"multipart/form-data",contentType:!1,cache:!1,processData:!1,error:function(a){console.error(a)},success:function(a,b,c){var d=JSON.parse(a),e="http://dev.images.moretao.com"+d.url+"!content",f=d.url.substring(9),g=$("#tagsId").val(),h=$("#sortable-list").children("div").length;$.post("/tags/insert/photos",{name:f,position:h,id:g},function(a){var b='<span id="remove_this" onclick="$(this).parent().remove();" class="fa fa-remove"></span>',c=$("#commodities-img").clone(),d=c.find("img");c.attr("id",null),d.attr("data-id",a.id),d.attr("src",e),d.attr("width","100%"),d.css("width","100%"),d.addClass("list-group-item"),c.prepend(b),$("#sortable-list").append(c),c.show(),$("#sortable-list").sortable("put",c),changeImgPosition()})}})})})});