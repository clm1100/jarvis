function reset(){history.go(0)}function changeImgPosition(){var a=$("#sortable-list");if(a.length>0){var b=a.attr("data-commodityid");a.sortable("destroy"),a.sortable({sort:!0,scroll:!0,animation:100,ghostClass:"sortable-ghost",onEnd:function(a){var c=[];$.each($("#sortable-list").find(".list-group-item"),function(a,b){if(0===a){var d=$("#commodity-main-img");d.find("img").attr("src",$(b).attr("src"))}c.push({id:$(b).attr("data-id"),position:++a})});var d="/commodities/"+b+"/photos/position";$.post(d,{list:c},function(a){})}})}}function deleteImg(a){var b=$("#sortable-list").attr("data-commodityid"),c="/commodities/"+b+"/photo/"+a;$.post(c,function(a){$.each($("#sortable-list").find(".list-group-item"),function(a,b){if(0===a){var c=$("#commodity-main-img");c.find("img").attr("src",$(b).attr("src"))}}),changeImgPosition()})}function bindCustomTagEdit(){var a=$("#commodity-main-img"),b=$(".custom-tag");$.pep.unbind(b),a.find(".custom-tag").pep({useCSSTranslation:!1,constrainTo:"parent",start:function(a){isDragDrop=!0}}),b.click(function(a){if(isDragDrop)return isDragDrop=!1,a.preventDefault(),!1;var b=$(a.currentTarget);b.attr("id","current-edit-custom-tag");var c=parseInt(b.find(".dot").css("left")),d=0===c?$("#add-tag-o-l-input"):$("#add-tag-o-r-input");d.prop("checked",!0);var e=$("#add-custom-tag-modal");return e.modal("show"),$("#is-edit-tag").val(!0),$("#custom-tag-input").val(b.find(".txt").html()),a.preventDefault(),!1})}function saveCustomTag(){var a=$("#add-custom-tag-modal"),b="true"===$("#is-edit-tag").val(),c=$("#custom-tag-input").val();if(b===!0){var d=$("#current-edit-custom-tag"),e=d.find(".txt");e.html(c);var f=$("input[name='add-tag-o-input']:checked").val();"l"===f?(d.find(".dot").animate({left:0}),e.animate({"border-radius":"0 10px 0 10px"})):(d.find(".dot").animate({left:parseInt(e.css("width"))+4}),e.animate({"border-radius":"10px 0 10px 0"}))}else{var g=$("#add-tag-x-input").val(),h=$("#add-tag-y-input").val(),i=doT.template($("#custom-tag-tpl").text()),j=i({txt:c,left:parseInt(g)/375,top:parseInt(h)/375}),k=$("#commodity-main-img");k.append(j),bindCustomTagEdit()}a.modal("hide")}function removeCustomTag(){$("#current-edit-custom-tag").remove()}function create(){window.location.href="/commodities/new"}function edit(a){window.open("/commodities/"+a,"_blank")}function destroy(a){BootstrapDialog.show({title:"此操作不可恢复!",message:"确认要删除这个商品吗?",buttons:[{label:"取消",action:function(a){a.close()}},{label:"删除",action:function(b){$.ajax({url:"/commodities/"+a,type:"DELETE",success:function(a){$(".alert strong").html(a.message),$(".alert").show().fadeIn(),b.close(),datatables?datatables.draw():history.go(-1)}})}}]})}function searchTags(){var a=$("#tags-list-select option:selected").val(),b=$("#tag-search-input").val();if($.trim(b).length<1)return!1;var c=doT.template($("#tags-tpl").text()),d="/api/tags/search/"+a+"/"+b+"/0";return $.get(d,function(a){var b=c(a);$("#tag-result-list").find("ul").append(b)}),!0}function addTags(){var a=$("#tag-result-list").find("input[name=tags]:checked").map(function(a,b){return $(b).parent()}).get();$("#tags-list-group").append(a),$("#add-tag-modal").modal("hide")}function searchUsers(a){var b;"zan"===a&&(b="#zan-search-input"),"comment"===a&&(b="#comment-search-input");var c=$(b).val();if($.trim(c).length<2)return!1;var d=doT.template($("#users-tpl").text()),e="/api/users/search/"+c+"/0";return $.get(e,function(b){"zan"===a&&(b.name="zans"),"comment"===a&&(b.name="comments");var c,e=d(b);"zan"===a&&(c="#zans-result-list"),"comment"===a&&(c="#comments-result-list"),$(c).find("ul").html(e)}),!0}function addZans(){var a=$("#zans-result-list").find("input[name=zans]:checked").map(function(a,b){return $(b).parent()}).get();$("#zans-list-group").append(a),$("#add-zan-modal").modal("hide")}function addComment(){$("#add-comment-modal").modal("show"),$("#comment-id-input").val(""),$("#comment-search-input").val(""),$("#comment-c-input").val(""),$("#comments-result-list").find("> ul").html("")}function editComment(a){$("#add-comment-modal").modal("show");var b=$(a).parent();$("#comment-id-input").val(b.attr("data-id"));var c=doT.template($("#users-tpl").text()),d=[];d.push({id:b.attr("data-user"),nickname:b.attr("data-nickname")});var e=c({items:d,checked:!0,name:"comments"});$("#comments-result-list").find("ul").html(e),$("#comment-c-input").val(b.attr("data-c"))}function removeComments(){var a=url(-1,window.location.href),b=$("#comment-id-input").val(),c="/commodities/"+a+"/comments/"+b;$.ajax({url:c,type:"DELETE",success:function(a){var b=$("#comments-list-group").find("> li");b.each(function(b,c){c=$(c);var d=c.attr("data-id");d===a.result&&c.remove(),$("#add-comment-modal").modal("hide")})}})}function saveComments(){var a=url(-1,window.location.href),b=$("#comment-id-input").val(),c=$("#comments-result-list input[name=comments]:checked").val(),d=$("#comment-c-input").val(),e={cid:b,user:c,c:d},f="/commodities/"+a+"/comments",g=doT.template($("#comments-tpl").text()),h=$("#comments-list-group");$.post(f,e,function(a){var b=$("#comments-list-group").find("> li"),c=!1;if(b.each(function(b,d){d=$(d);var e=d.attr("data-id");if(e===a._id){var f=g(a);d.html(f),c=!0}}),!c){var d=g(a);h.prepend(d)}$("#add-comment-modal").modal("hide")})}function searchTopics(){var a=$("#topic-search-input").val();if($.trim(a).length<1)return!1;var b=doT.template($("#topics-tpl").text()),c="/api/topics/search/"+a+"/0";return $.get(c,function(a){var c=b(a);$("#topics-result-list").find("ul").html(c)}),!0}function addTopics(){var a=$("#topics-result-list").find("input[name=topics]:checked").map(function(a,b){return $(b).parent()}).get();$("#topics-list-group").append(a),$("#add-topic-modal").modal("hide")}function saveCommodity(){var a=[],b=$("#commodity-main-img").find(".custom-tag");return $.each(b,function(b,c){var d=$(c),e=d.find(".txt").html(),f=parseInt(d.find(".dot").css("left")),g=parseFloat(d.css("left").replace("px","")),h=parseFloat(d.css("top").replace("px",""));a.push({txt:e,x:g/384,y:h/384,o:0===f?"l":"r"})}),$("#custom-tags-input").val(JSON.stringify(a)),!0}function sort(){window.location.href="/commodities/sortable"}function preview(){var a=$(".preview").attr("id"),b="/commodities/preview?"+a;window.open(b,"newwindow","width=1000, top=0, left=0, toolbar=no, menubar=no, scrollbars=no, resizable=no, location=no, status=no")}function checkPreview(){var a=$("#commodity-main-img img").attr("src");a&&preview()}function categoriesAjax(a){var b="/api/get_categories/son/"+a;$.get(b,function(a){var b=doT.template($("#categories-tpl").text());if(a.items.length>0){var c=b(a);$("#categories_filter_cc").append(c)}})}function addCategories(){var a,b,c=$("#categories_filter_cc select :selected").last().val(),d=$("#categories_filter_cc select :selected").last().text(),e=$("#categories_filter_cc select :selected").eq(-2).val(),f=$("#categories_filter_cc select :selected").eq(-2).text();c&&d?(a='<li><input type="checkbox" name="categories" value='+c+" title= "+d+' checked=""> '+d+"</li>",b=$(a)):(a='<li><input type="checkbox" name="categories" value='+e+" title="+f+' checked=""> '+f+"</li>",b=$(a)),$("#categories-list-group").append(b),$("#add-categories-modal").modal("hide")}var datatables,isDragDrop;$(document).ready(function(){var a=$("#main-datatables");a.length>0&&(datatables=a.DataTable({language:{url:"/javascripts/libs/datatables-chinese.json"},autoWidth:!1,processing:!0,serverSide:!0,pagingType:"listbox",order:[[10,"desc"]],ajax:"/api/commodities",fnServerParams:function(a){var b=[],c=$("#is_selected_filter").val();c&&c.length>0&&b.push({i:5,value:c});var d=$("#is_publish_filter").val();d&&d.length>0&&b.push({i:7,value:d});var e=$("#is_light_filter").val();e&&e.length>0&&b.push({i:6,value:e});var f=$("#force_top_filter").val();f&&f.length>0&&b.push({i:11,value:f});var g=$("#start_date_filter").val(),h=$("#end_date_filter").val();if(g.length>0&&h.length>0){var i=moment(g,"YYYY年MM月DD日").format("MM/DD/YYYY"),j=moment(h,"YYYY年MM月DD日").format("MM/DD/YYYY");b.push({i:11,value:{start:i,end:j}})}a.filters=b},columns:[{name:"_id"},{name:"t"},{name:"url",visible:!1},{name:"price"},{name:"tags"},{name:"is_selected"},{name:"is_light"},{name:"is_publish"},{name:"user"},{name:"categories",visible:!1},{name:"at"},{name:"force_top",visible:!1}],columnDefs:[{targets:[10],render:function(a,b,c){return moment(a).fromNow()}},{targets:[12],render:function(a,b,c){return"<button onclick=\"edit('"+c[0]+"')\" class='btn btn-info'>编辑</button>&nbsp;<button onclick=\"destroy('"+c[0]+"')\" class='btn btn-danger'>删除</button>"}}]}),$("#is_selected_filter,#is_publish_filter, #is_light_filter, #force_top_filter, #start_date_filter, #end_date_filter").change(function(){datatables.draw()}));var b=$("#at-datetime-select");b&&b.length>0&&b.datetimepicker({format:"YYYY年MM月DD日 HH:mm:ss"});var c=$("#content-textarea");if(c.length>0){UE.getEditor("content-textarea")}changeImgPosition();var d=$("#commodity-main-img");d.length>0&&(bindCustomTagEdit(),d.bind("click",function(a){$("#add-tag-x-input").val(a.offsetX),$("#add-tag-y-input").val(a.offsetY),$("#add-tag-o-l-input").prop("checked",!0);var b=$("#add-custom-tag-modal");return $("#is-edit-tag").val(!1),$("#custom-tag-input").val(""),b.modal("show"),a.preventDefault(),!1}))}),$("#categories_filter").change(function(){var a=$.map($("#categories_filter").find("option:selected"),function(a){return a.value});$("#categories_arry").val(a)}),$("#cover-input").change(function(){var a="/api/photos/upload/signature",b=document.getElementById("cover-input").files[0],c=Math.floor((new Date).getTime()/1e3)+86400;$.post(a,{filename:b.name,expiration:c},function(a){var c=new FormData;c.append("policy",a.policy),c.append("signature",a.signature),c.append("file",b),c.append("x-gmkerl-rotate","auto"),$.ajax({url:UPYUN_MORETAO,type:"POST",data:c,mimeType:"multipart/form-data",contentType:!1,cache:!1,processData:!1,error:function(a){console.error(a)},success:function(a,b,c){var d=JSON.parse(a),e="http://dev.images.moretao.com"+d.url+"!content",f=d.url.substring(9),g=$("#commodities_id").val(),h=$("#sortable-list").children("div").length;$.post("/commodities/insert/photos",{name:f,position:h,id:g},function(a){var b="<span id='remove_this' onclick='$(this).parent().remove();' class='fa fa-remove'></span>",c=$("#commodities-img").clone(),d=c.find("img");c.attr("id",null),d.attr("data-id",a.id),d.attr("src",e),d.attr("width","100%"),d.css("width","100%"),d.addClass("list-group-item"),c.prepend(b),$("#sortable-list").append(c),c.show(),$("#sortable-list").sortable("put",c),changeImgPosition()})}})})}),$(function(){var a=$("#commodities-sortable-list");a.length>0&&a.sortable({sort:!0,scroll:!0,animation:100,ghostClass:"sortable-ghost",onEnd:function(a){var b=[];$.each($(".list-group-item"),function(a,c){b.push({id:$(c).attr("data-id"),position:++a})});var c="/commodities/sortable";$.post(c,{list:b},function(a){})}})}),$(function(){$("#categories_filter_cc").on("change","select",function(){var a=$(this).val();$(this).nextAll().remove(),categoriesAjax(a)})});