function sort(){window.location.href="/activities/sortable"}function create(){window.location.href="/activities/new"}function edit(a){window.open("/activities/"+a,"_balnk")}function reset(){$("#is_publish_filter, #start_date_filter, #end_date_filter").val(""),datatables.draw()}function destroy(a){BootstrapDialog.show({title:"此操作不可恢复!",message:"确认要删除这个攻略吗?",buttons:[{label:"取消",action:function(a){a.close()}},{label:"删除",action:function(b){$.ajax({url:"/activities/"+a,type:"DELETE",success:function(a){$(".alert strong").html(a.message),$(".alert").show().fadeIn(),b.close(),datatables?datatables.draw():history.go(-1)}})}}]})}function searchTags(a){var b=$("#tag-earch-input").val();if($.trim(b).length<2)return!1;var c=doT.template($("#tags-tpl").text()),d="/api/tags/search/"+a+"/"+b+"/0";return $.get(d,function(a){var b=c(a);$("#tag-result-list").find("ul").append(b)}),!0}function addTags(){var a=$("#tag-result-list").find("input[name=tags]:checked").map(function(a,b){return $(b).parent()}).get();$("#tags-list-group").append(a),$("#add-tag-modal").modal("hide")}function searchUsers(a){var b;"zan"===a&&(b="#zan-search-input"),"comment"===a&&(b="#comment-search-input");var c=$(b).val();if($.trim(c).length<2)return!1;var d=doT.template($("#users-tpl").text()),e="/api/users/search/"+c+"/0";return $.get(e,function(b){"zan"===a&&(b.name="zans"),"comment"===a&&(b.name="comments");var c,e=d(b);"zan"===a&&(c="#zans-result-list"),"comment"===a&&(c="#comments-result-list"),$(c).find("ul").html(e)}),!0}function addComment(){$("#add-comment-modal").modal("show"),$("#comment-id-input").val(""),$("#comment-search-input").val(""),$("#comment-c-input").val(""),$("#comments-result-list").find("> ul").html("")}function editComment(a){$("#add-comment-modal").modal("show");var b=$(a).parent();$("#comment-id-input").val(b.attr("data-id"));var c=doT.template($("#users-tpl").text()),d=[];d.push({id:b.attr("data-user"),nickname:b.attr("data-nickname")});var e=c({items:d,checked:!0,name:"comments"});$("#comments-result-list").find("ul").html(e),$("#comment-c-input").val(b.attr("data-c"))}function removeComments(){var a=url(-1,window.location.href),b=$("#comment-id-input").val(),c="/activities/"+a+"/comments/"+b;$.ajax({url:c,type:"DELETE",success:function(a){var b=$("#comments-list-group").find("> li");b.each(function(b,c){c=$(c);var d=c.attr("data-id");d===a.result&&c.remove(),$("#add-comment-modal").modal("hide")})}})}function saveComments(){var a=url(-1,window.location.href),b=$("#comment-id-input").val(),c=$("#comments-result-list input[name=comments]:checked").val(),d=$("#comment-c-input").val(),e={cid:b,user:c,c:d},f="/activities/"+a+"/comments",g=doT.template($("#comments-tpl").text()),h=$("#comments-list-group");$.post(f,e,function(a){var b=$("#comments-list-group").find("> li"),c=!1;if(b.each(function(b,d){d=$(d);var e=d.attr("data-id");if(e===a._id){var f=g(a);d.html(f),c=!0}}),!c){var d=g(a);h.prepend(d)}$("#add-comment-modal").modal("hide")})}var datatables,ueActivity;$(document).ready(function(){var a=$("#main-datatables");a.length>0&&(datatables=a.DataTable({language:{url:"/javascripts/libs/datatables-chinese.json"},processing:!0,serverSide:!0,ajax:"/api/activities",order:[[3,"desc"]],fnServerParams:function(a){var b=[],c=$("#is_publish_filter").val();c&&c.length>0&&b.push({i:4,value:c});var d=$("#start_date_filter").val(),e=$("#end_date_filter").val();if(d.length>0&&e.length>0){var f=moment(d,"YYYY年MM月DD日").format("MM/DD/YYYY"),g=moment(e,"YYYY年MM月DD日").format("MM/DD/YYYY");b.push({i:3,value:{start:f,end:g}})}a.filters=b},columns:[{name:"_id"},{name:"t"},{name:"cover"},{name:"at"},{name:"end"},{name:"limit"},{name:"count"},{name:"is_publish"},{name:"position"}],columnDefs:[{targets:[2],render:function(a,b,c){return a?"<a data-lightbox='"+c[0]+"' href='"+a.replace("!thumb","")+"'><img src='"+a+"' width='24'></a>":""}},{targets:[3],render:function(a,b,c){return a?moment(a).format("YYYY年MM月DD日"):""}},{targets:[4],render:function(a,b,c){return a?moment(a).format("YYYY年MM月DD日"):""}},{targets:[5],render:function(a,b,c){return-1===a?"无限制":a}},{targets:[9],render:function(a,b,c){return"<button onclick=\"edit('"+c[0]+"')\" class='btn btn-info'>编辑</button>&nbsp;<button onclick=\"destroy('"+c[0]+"')\" class='btn btn-danger'>删除</button>"}}]}),$("#start_date_filter, #end_date_filter").change(function(){datatables.draw()}));var b=$("#content-textarea");b.length>0&&(ueActivity=UE.getEditor("content-textarea"),ueActivity.ready(function(){$("#myTabContent .activity_add").click(function(){var a='<link data="activity_link" href="http://2.suancai.sinaapp.com/theme3.css" rel="stylesheet">',b=ueActivity.getContent();-1===b.indexOf("activity_link")&&ueActivity.setContent(a+b),$(this).addClass("pulse animated").one("webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",function(){$(this).removeClass("pulse animated")});var c=$(this).html();ueActivity.setContent(c,!0)})})),$("#activities_preview").click(function(){var a='<link href="http://statics.moretao.com/stylesheets/application.css?version=201510211710" rel="stylesheet">'+ueActivity.getContent(),b=window.open("","newwindow","height=800, width=400, top=0, left=300, toolbar=no, menubar=no, scrollbars=no, resizable=no, location=no, status=no");b.document.write(a)});var c=$("#cover-input");if(c.length>0){new ImagePreview("#cover-input",{placeholder:"#cover-preview",height:"128px",callback:function(){$("#show-cover-link").attr("href",$("#cover-preview").find("> img").attr("src"))}})}var d=$("#sortable-list");d.length>0&&d.sortable({sort:!0,scroll:!0,animation:100,ghostClass:"sortable-ghost",onEnd:function(a){var b=[];$.each($(".list-group-item"),function(a,c){b.push({id:$(c).attr("data-id"),position:++a})});var c="/activities/sortable";$.post(c,{list:b},function(a){})}})});